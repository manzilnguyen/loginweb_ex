<!DOCTYPE html>
<html lang="vi">
    <head>
        <title>Trang Quản Trị</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <nav>
            <ul>
                <li class="brand">MyApp</li>
            </ul>
            <ul>
                <li><a href="#" id="logout-button" role="button" class="contrast">Đăng Xuất</a></li>
            </ul>
        </nav>

        <main class="container-fluid animate__animated animate__fadeInUp"> 
            
            <header>
                <hgroup>
                    <h1>Bảng điều khiển</h1>
                    <h2 id="welcome-message">Chào mừng trở lại!</h2>
                </hgroup>
            </header>

            <article>
                <header><strong>Thông tin cá nhân của bạn</strong></header>
                <div id="user-data">
                    <p aria-busy="true">Đang tải thông tin...</p>
                </div>
            </article>
            
            <hr>

            <section>
                <hgroup>
                    <h3>Quản lý Người Dùng</h3>
                    <h5>Toàn bộ người dùng trong hệ thống</h5>
                </hgroup>
                
                <button id="show-all-button" class="secondary">
                    Tải Toàn Bộ Database
                </button>
                
                <div id="all-users-data" style="display: none; margin-top: 1rem; overflow-x: auto;">
                    <p id="table-message" class="message"></p>
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Họ và Tên</th>
                                <th>Lớp</th>
                            </tr>
                        </thead>
                        <tbody id="all-users-table-body">
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
        
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                document.body.classList.add('fade-in');
                
                const token = localStorage.getItem('access_token');
                
                const userDataDiv = document.getElementById('user-data');
                const logoutButton = document.getElementById('logout-button');
                const showAllButton = document.getElementById('show-all-button');
                const allUsersDataDiv = document.getElementById('all-users-data');
                const tableBody = document.getElementById('all-users-table-body');
                const tableMessage = document.getElementById('table-message');
                const welcomeMessage = document.getElementById('welcome-message');

                if (!token) {
                    document.body.classList.remove('fade-in');
                    window.location.href = 'login.html';
                    return; 
                }

                // --- 1. LẤY DỮ LIỆU CÁ NHÂN ---
                fetch('http://localhost:5000/data', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    if (!response.ok) { 
                        throw new Error('Phiên đăng nhập không hợp lệ'); 
                    }
                    return response.json();
                })
                .then(data => {
                    welcomeMessage.textContent = `Chào mừng trở lại, ${data.name || data.username}!`;
                    userDataDiv.innerHTML = `
                        <ul>
                            <li><strong>Tên đăng nhập:</strong> ${data.username}</li>
                            <li><strong>Họ và tên:</strong> ${data.name || 'Chưa cập nhật'}</li>
                            <li><strong>Lớp:</strong> ${data.class || 'Chưa cập nhật'}</li>
                        </ul>
                    `;
                })
                .catch(error => {
                    console.error("Error:", error);
                    localStorage.removeItem('access_token');
                    document.body.classList.remove('fade-in');
                    window.location.href = 'login.html';
                });
                
                // --- 2. LOGIC NÚT ĐĂNG XUẤT ---
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('access_token');
                    document.body.classList.remove('fade-in');
                    setTimeout(() => { window.location.href = 'login.html'; }, 500);
                });
                
                // --- 3. LOGIC NÚT "HIỂN THỊ TẤT CẢ" ---
                showAllButton.addEventListener('click', () => {
                    allUsersDataDiv.style.display = 'block';
                    showAllButton.setAttribute('aria-busy', 'true');
                    showAllButton.textContent = 'Đang tải...';
                    tableMessage.classList.remove('show', 'error');
                    
                    fetch('http://localhost:5000/admin/all_users', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                    .then(response => {
                        if (!response.ok) { 
                            return response.json().then(err => { throw new Error(err.message); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        tableBody.innerHTML = ''; 
                        if (data.all_users.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="4">Không có người dùng nào trong database.</td></tr>';
                        }
                        
                        data.all_users.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                fs
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.name || 'N/A'}</td>
                                <td>${user.class || 'N/A'}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        tableBody.innerHTML = '';
                        tableMessage.textContent = error.message;
                        tableMessage.className = 'message error show';
                    })
                    .finally(() => {
                        showAllButton.removeAttribute('aria-busy');
                        showAllButton.textContent = 'Tải Toàn Bộ Database';
                    });
                });
            });
        </script>
    </body>
</html>